---
SPDX-License-Identifier: MIT
path: "/tutorials/setup-soketi-websocket-server-behind-reverse-proxy"
slug: "setup-soketi-websocket-server-behind-reverse-proxy"
date: "2024-08-04"
title: "Installation eines Soketi WebSocket-Servers hinter einem Reverse-Proxy-Server (NGINX)"
short_description: "In diesem Tutorial erfahren Sie, wie Sie einen Soketi WebSocket-Server hinter einem Reverse-Proxy-Server, auf der Basis eines NGINX-Servers, einrichten und betreiben."
tags: ["WebSockets", "NGINX"]
author: "crocodile2024"
author_link: "https://github.com/crocodile2024"
author_img: ""
author_description: ""
language: "de"
available_languages: ["de"]
header_img: "header-1"
---

## Einleitung

In diesem Tutorial lernen Sie, wie Sie einen Soketi WebSocket-Server hinter einem NGINX Reverse-Proxy-Server betreiben können. Dieser ist dann durch den NGINX Reverse-Proxy-Server mit einer SSL-Verschlüsselung geschützt. Das SSL-Zertifikat wird mit Let's Encrypt erstellt und ist somit kostenlos. Die Erneuerung dieses Zertifikats erfolgt automatisch mit der Hilfe von dem Komandozeilenprogramm acme.sh.

Offizielle Dokumentation: [https://docs.soketi.app/](https://docs.soketi.app/)<br>
Projekt Website: [https://soketi.app/](https://soketi.app/)

**Vorraussetzungen**

* Sie benötihen einen Domain-Namen (Sub-Domain ist ausreichend)
* Entwas Erfahrung im Umgang mit NodeJS und NPM
* einen Server (zum Beispiel in der [Hetzner Cloud](https://hetzner.cloud))

## Schritt 1 - Neuer Cloud-Server bestellen

* Melden Sie sich in der [Hetzner Cloud Konsole](https://console.hetzner.cloud) an.
* Erstellen Sie, wenn Sie das wollen, ein neues Peojekt und nennen Sie es, wie Sie möchten.
* Wählen Sie einen Standort und ein Server-Modell.
* Klicken Sie auf "Server hinzufügen". In diesem Tutorial benutze ich das Betriebsystem Debian 12.
* Als Cloud-Konfig müssen Sie nichts eingeben.
* Wählen Sie Ihren SSH-Schlüssel
    * Sie können [diesen Artikel](https://help.github.com/en/enterprise/2.16/user/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) lesen, falls Sie Hilfe bei der Erstellung eines SSH-Schlüssels benötigen.
* Trahen Sie den Namen Ihres Servers noch im Feld `name` ein (ws.example.de)
* Klicken Sie auf `Kostenpflichtig bestellen`


## Schritt 2 - DNS einrichten

Sie benötigen für dieses Tutorial einen DNS-Eintrag, welcher auf Ihren in Schritt 1 bestellen Server verweist. Dies ist notwendig, damit Ihnen ein SSL-Zertifikat ausgestellt werden kann.

Ihre DNS-Konfiguration sollte dann so ausehen:

```
# Name              Type       Value
ws                IN A       10.0.0.1
ws                IN AAAA    2001:db8:1234::1
```

## Step 3 - Updates installieren und notwendige Pakete installieren

Warten Sie einen kurzen Moment, bis Ihr bestellter Server installier wurde. Sobald dies abgeschlossen ist, können Sie sich mit dem Server über SSH und Ihrer IP-Adresse oder der in Schritt 2 festgelegten Subdomain (hier ws.example.de) verbinden.

Paketlisten aktualisieren und Updates installieren:
`apt update && apt upgrade -y`

Anschließend sollten Sie den Server neustarten, um eventuell den aktualisierten Kernel zu laden.

Als nächstes installieren wir alle notwendigen Pakete:

'apt-get install git python3 gcc build-essential nodejs npm'

Wenn Sie einen Server in der Hetzner-Cloud verwenden, dann müssen Sie noch das Pekt 'apparmor' installieren. Ansonsten würden Sie im späteren Verlauf dieses Tutorials Probleme bekommen.

'apt-get install apparmor'

Anschließend installieren wir die beiden NodeJS-Pakete soketi und pm2:

'npm install -g @soketi/soketi'
'npm install -g pm2'

## Schritt 4 - Konfiguration für Soketi erstellen

Sie können die folgende Konfigurationsdatek als Basis benutzen und gegebenenfalls auf Ihre Bedürfnisse anpassen:

'{
  "host": "127.0.0.1",
  "port": 6001,
  "appManager": {
    "driver": "array",
    "options": {
      "apps": [
        {
          "id": "my-app-id",
          "key": "my-app-key",
          "secret": "my-app-secret",
          "name": "My App",
          "enableClientMessages": true,
          "enableStatistics": true
        }
      ]
    }
  }
}'

Wenn diese Konfigurationsdatei berwendet wird, dann muss keine weitere Konfiguration vor dem ersten Start gemacht werden.

Kopieren Sie sich die Konfiguration, welche Sie für Ihren Zweck benötigen. Erstellen sie dann mit einem Texteditor in dem DSH-Terminal eine neue Datei:

'nano config.json'

Fügen Sie dann den kopierten Inhalt in die Datei ein und speichern Sie die Datei mit der Tastenkompination 'STRG + O'.

## Schritt 5 - Erster Start des Soketi-Servers (noch ohne PM2):
Starten Sie nun den Soketi-Server, indem Sie den folgenden Befehl in einem Terminal ausführen:

'soketi start --config="<Pfad zu Ihrer Konfigurationsdatei>"'


## Schritt 6 - Erster Test des Websocket-Servers mit Laravel 11:

Ändern Sie die folgenden Werte in der .env-Datei:

'BROADCAST_DRIVER=pusher
PUSHER_APP_ID=your-app-id
PUSHER_APP_KEY=your-app-key
PUSHER_APP_SECRET=your-app-secret
PUSHER_APP_CLUSTER=mt1'

Überprüfen Sie die Einstellungen in der folgenden Datei 'config/brodcasting.php':

'connections' => [
    'pusher' => [
        'driver' => 'pusher',
        'key' => env('PUSHER_APP_KEY'),
        'secret' => env('PUSHER_APP_SECRET'),
        'app_id' => env('PUSHER_APP_ID'),
        'options' => [
            'cluster' => env('PUSHER_APP_CLUSTER'),
            'useTLS' => true,
        ],
    ],
    // weitere Verbindungen...
],

## Schritt 7 - Erste Events auslösen

Sie können nun die ersten Events mit Ihrem WebSocket-Server verschicken.


## Schritt 8 - Auto-Start für den Socketi Server konfigurieren:

Damit der Soketi-Server auch nach einem Neustart des Cloud-Servers wieder automatisch gestartet wird, müssen wir nun noch 'pm2' einrichten:

Führen Sie hierzu die folgenden Befehle aus:

- pm2 start soketi --name WebSoket-Server -- start --config="<Pfad zur Konfigurationsdatei>"
- pm2 startup (Dann wird der autostart aktiviert) Folgen Sie den Anweisungen auf dem Bildschirm.


## Schritt 9 - Reverse Proxy einrichten
Nun muss der Reverse Proxy Server noch eingerichtet werden. Dieser wird die SSL-Verbindung bereitstellen und dann an den soketi Server weitergeben. Erstellen Sie hierfür eine neue Datei im Ordner '/etc/nginx/sites-available/'.

'mkdir /etc/nginx/ssl'
'nano /etc/nginx/sites-available/soketi'

Fühen Sie folgenden Inhalt in die Datei ein:

'server {
    listen 443 ssl;
    server_name ws.example.de;

    ssl_certificate /etc/nginx/ssl/ws.example.de.cer;
    ssl_certificate_key /etc/nginx/ssl/ws.example.de.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://localhost:6001;  # Ersetze den Port, falls soketi auf einem anderen Port läuft
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name ws.example.de;

    location / {
        return 301 https://$host$request_uri;
    }
}'

## Schritt 10 - SSL-Zertifikat erstellen

Für die Erstellung des Zertifikats benutzen wir das Shell-Script 'acme.sh'. Dieses installieren Sie mit dem folgenden Befehl:

'curl https://get.acme.sh | sh -s email=<Ihre E-Mail-Adresse>'
	
	An diese E-Mail-Adresse werden dann Erinnerungen geschickt, wenn ein Zertifikat abläuft oder wenn es Probleme bei der Verlängerung gibt.

	'systemctl stop nginx && acme.sh  --issue  -d ws.example.de  --standalone'
	
	'ln -s /etc/nginx/sites-available/ws /etc/nginx/sites-enabled/ws'
	
	'acme.sh --install-cert -d ws.example.de --cert-file /etc/nginx/ssl/mustermann-domain.de.cer --key-file /etc/nginx/ssl/ws.example.de.key --fullchain-file /etc/nginx/ssl/fullchain.pem --reloadcmd "systemctl reload nginx"'
	
	'systemctl start nginx'
	
## Fertig

Ihr WebSocket Server ist nun mit einer SSL-Verschlüsselung ausgestattet. In der Konfiguration von Laravel muss nun der Port auf '443' geändert werden.

##### License: MIT
