---
SPDX-License-Identifier: MIT
path: "/tutorials/setup-soketi-websocket-server-behind-reverse-proxy"
slug: "setup-soketi-websocket-server-behind-reverse-proxy"
date: "2024-08-04"
title: "Setting up a Soketi WebSocket Server behind a Reverse Proxy (NGINX)"
short_description: "In this tutorial, you will learn how to set up and operate a Soketi WebSocket server behind an NGINX-based reverse proxy server."
tags: ["WebSockets", "NGINX"]
author: "crocodile2024"
author_link: "https://github.com/crocodile2024"
author_img: ""
author_description: ""
language: "en"
available_languages: ["de"]
header_img: "header-1"
---

## Introduction

In this tutorial, you will learn how to operate a Soketi WebSocket server behind an NGINX reverse proxy server, which will be protected by SSL encryption. The SSL certificate will be created using `Let's Encrypt` and is thus free. The renewal of this certificate is automated with the help of the command-line program acme.sh.

Official Documentation: [https://docs.soketi.app/](https://docs.soketi.app/)<br>
Project Website: [https://soketi.app/](https://soketi.app/)

**Requirement**

* You need a domain name (a subdomain is sufficient)
* Some experience with NodeJS and NPM
* A server (for example, in the [Hetzner Cloud](https://hetzner.cloud))

## Step 1 - Order a new cloud server

* Log in to the [Hetzner Cloud Console](https://console.hetzner.cloud).
* Create a new project if you want, and name it as you wish.
* Choose a location and a server model.
* Click on "Add Server". In this tutorial, I use the Debian 12 operating system.
* No need to enter anything in the cloud config.
* Select your SSH key.
    * You can read [this article](https://help.github.com/en/enterprise/2.16/user/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent) if you need help creating an SSH key.
* Enter the name of your server in the `name` field (ws.example.de).
* Click on `Order for a fee`.

## Step 2 - Set up DNS

You need a DNS entry that points to the server you ordered in step 1. This is necessary for an SSL certificate to be issued to you.

Your DNS configuration should look like this:

```
# Name              Type       Value
ws                IN A       10.0.0.1
ws                IN AAAA    2001:db8:1234::1
```

## Step 3 - Install updates and necessary packages

Wait a moment until your ordered server is installed. Once completed, you can connect to the server via SSH using your IP address or the subdomain set in step 2 (here ws.example.de).

Update package lists and install updates:
`apt update && apt upgrade -y`

Then restart the server to load any updated kernel.

Next, install all necessary packages:

`apt-get install git python3 gcc build-essential nodejs npm`

If you are using a server in the Hetzner Cloud, you need to install the `apparmor` package. Otherwise, you will encounter issues later in this tutorial.

`apt-get install apparmor`

Next, install the two NodeJS packages soketi and pm2:

`npm install -g @soketi/soketi`
`npm install -g pm2`

## Step 4 - Create configuration for Soketi

You can use the following configuration file as a basis and adjust it to your needs:

```
{
  "host": "127.0.0.1",
  "port": 6001,
  "appManager": {
    "driver": "array",
    "options": {
      "apps": [
        {
          "id": "my-app-id",
          "key": "my-app-key",
          "secret": "my-app-secret",
          "name": "My App",
          "enableClientMessages": true,
          "enableStatistics": true
        }
      ]
    }
  }
}
```

If this configuration file is used, no further configuration is required before the first start.

Copy the configuration you need. Then create a new file with a text editor in the SSH terminal:

`nano config.json`

Paste the copied content into the file and save it with the key combination `CTRL + O`.

## Step 5 - First start of the Soketi server (without PM2):

Now start the Soketi server by running the following command in a terminal:

`soketi start --config="<path to your configuration file>"`

## Step 6 - First test of the WebSocket server with Laravel 11:

Change the following values in the .env file:

```
BROADCAST_DRIVER=pusher
PUSHER_APP_ID=your-app-id
PUSHER_APP_KEY=your-app-key
PUSHER_APP_SECRET=your-app-secret
PUSHER_APP_CLUSTER=mt1
```

Check the settings in the following file `config/broadcasting.php`:

```
'connections' => [
    'pusher' => [
        'driver' => 'pusher',
        'key' => env('PUSHER_APP_KEY'),
        'secret' => env('PUSHER_APP_SECRET'),
        'app_id' => env('PUSHER_APP_ID'),
        'options' => [
            'cluster' => env('PUSHER_APP_CLUSTER'),
            'useTLS' => true,
        ],
    ],
    // other connections...
],
```

## Step 7 - Trigger first events

You can now send the first events with your WebSocket server.

## Step 8 - Configure auto-start for the Soketi server:

To ensure the Soketi server starts automatically after a reboot of the cloud server, we need to configure `pm2`:

Run the following commands:

- `pm2 start soketi --name WebSocket-Server -- start --config="<path to the configuration file>"`
- `pm2 startup` (Then the autostart is activated) Follow the instructions on the screen.

## Step 9 - Set up reverse proxy

Now we need to set up the reverse proxy server. This will provide the SSL connection and then forward it to the soketi server. Create a new file in the `/etc/nginx/sites-available/` directory.

`mkdir /etc/nginx/ssl`
`nano /etc/nginx/sites-available/soketi`

Add the following content to the file:

```
server {
    listen 443 ssl;
    server_name ws.example.de;

    ssl_certificate /etc/nginx/ssl/ws.example.de.cer;
    ssl_certificate_key /etc/nginx/ssl/ws.example.de.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
        proxy_pass http://localhost:6001;  # Replace the port if soketi is running on a different port
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

server {
    listen 80;
    server_name ws.example.de;

    location / {
        return 301 https://$host$request_uri;
    }
}
```

## Step 10 - Create SSL certificate

To create the certificate, we use the shell script `acme.sh`. Install it with the following command:

`curl https://get.acme.sh | sh -s email=<your-email-address>`

You will receive reminders at this email address when a certificate expires or if there are issues with renewal.

```
systemctl stop nginx && acme.sh --issue -d ws.example.de --standalone --server letsencrypt
ln -s /etc/nginx/sites-available/ws /etc/nginx/sites-enabled/ws
acme.sh --install-cert -d ws.example.de --cert-file /etc/nginx/ssl/ws.example.de.cer --key-file /etc/nginx/ssl/ws.example.de.key --fullchain-file /etc/nginx/ssl/fullchain.pem --reloadcmd "systemctl reload nginx"
systemctl start nginx
```

## Done

Your WebSocket server is now equipped with SSL encryption. In the Laravel configuration, you need to change the port to `443`.

##### License: MIT
